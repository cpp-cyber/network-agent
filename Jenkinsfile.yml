pipeline {
  agent none

  environment {
    LD_LIBRARY_PATH = "-L/network-agent-linux/libpcap-1.4.0"
    CGO_LDFLAGS = "-L/network-agent-linux/libpcap-1.4.0"
    CGO_CPPFLAGS = "-I/network-agent-linux/libpcap-1.4.0"
    VERSION = "v1.0.0"
  }

  tools { go '1.21.5' }

  stages {
    stage('Prepare Workspace') {
      agent {
        label 'network-agent'
      }
      steps {
        sh 'curl https://www.tcpdump.org/release/libpcap-1.4.0.tar.gz --output libpcap-1.4.0.tar.gz'
        sh 'tar xvf libpcap-1.4.0.tar.gz'
        sh 'cd libpcap-1.4.0; ./configure --with-pcap=linux && make'
      }
    }
    stage('Compile') {
      parallel {
        stage('Ubuntu 22') {
          agent {
            label 'network-agent'
          }
          steps {
            sh '/var/jenkins/build.sh'
          }
        }
      }
    }
  }
}
